version: '3'

services:

  localstack:
    image: localstack/localstack:0.8.7
    environment:
      - SERVICES=s3:5000
      - DEFAULT_REGION=us-east-1
      - HOSTNAME=localstack

  elasticsearch:
    image: elasticsearch:6.7.1
    environment:
      - discovery.type=single-node
    ports:
      - "9200:9200"

  kibana:
    image: kibana:6.7.1
    ports:
      - "5601:5601"

  image-colors:
    build: ./images/lambda/.
    command: /app/build/image-colors
    volumes:
      - "../..:/app"
    environment:
      - LAMBDA_EXTERNAL_PORT=8002
      - _LAMBDA_SERVER_PORT=8001
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=foo
      - AWS_SECRET_ACCESS_KEY=foo
      - AWS_S3_ENDPOINT=http://localstack:5000
      - AWS_S3_USE_PATH=true
      - ELASTIC_HOSTS=http://elasticsearch:9200
      - ELASTIC_INDEX=image_colors

  test_runner:
    build: ./images/runner
    command: 'true' # no-op by default, redefined in run.sh
    environment:
      - STORAGE_PATH=/var/storage
      - S3_ENDPOINT=http://localstack:5000
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=foo
      - AWS_SECRET_ACCESS_KEY=foo
      - BUCKET_NAME=sample-bucket
      - ELASTIC_ENDPOINT=http://elasticsearch:9200
      - ELASTIC_INDEX=image_colors
      - LAMBDA_ENDPOINT=image-colors:8002

volumes:
  esdata:
    driver: local
